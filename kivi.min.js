var kivi={config:{},_store:{},_reportedMap:{},_startingIntervalSeries:[],get:function(a){return this._store[a]},set:function(a,b){if(this.get(a))this.onError(Error("kivi: You already set key["+a+"] to ["+this.get(a)+"]."));else if("number"!==typeof b)this.onError(Error("kivi: ["+a+"]["+b+"] is not a number."));else this._store[a]=b},isReported:function(a){return!!this._reportedMap[a]},_markReported:function(a){this._reportedMap[a]=!0},clear:function(){this._store={};this._reportedMap={}},onError:function(a){this.log(a.message)},
log:function(a){if(window.console&&window.console.log){var b=Array.prototype.slice.call(arguments);console.log(b.join(" "))}},getConfig:function(a){if(this.config[a])return this.config[a];throw Error("kivi: You need to set kivi.config."+a);},postKeys:function(){var a=[];this._.each(this._store,function(b,c){this.isReported(c)||a.push(c)},this);return a},postList:function(a){var b=[];a=a||this.postKeys();this._.each(a,function(a){a={key:a,val:this.get(a)};b.push(a)},this);return b},postData:function(a){return this.postList(a)},
post:function(){var a=this,b=this.getConfig("$"),c=this.getConfig("postUrl"),f=this.getToJSON();if(b&&c&&f){var d=this.postKeys();0<d.length&&(this._.each(d,function(a){this._markReported(a)},this),d=this.postData(d),b.ajax({url:c,type:"POST",data:f(d),contentType:"application/json",success:function(){},error:function(b,c,d){a.onError(Error("kivi: Error posting stats: "+c+" "+d))}}))}},getToJSON:function(){var a;window.JSON&&window.JSON.stringify&&(a=window.JSON.stringify);if(!a){var b=this.getConfig("$");
b&&b.toJSON&&(a=b.toJSON)}return a},_setTimer:function(){var a=this,b=this._startingIntervalSeries.shift();b&&(this._timer=setTimeout(function(){a.post();a._setTimer()},b))},enablePost:function(a){this._startingIntervalSeries=a||[];this._setTimer()},disablePost:function(){this._startingIntervalSeries=null;clearTimeout(this._timer)}};
(function(){var a=Array.prototype.forEach,b={};kivi._={};kivi._.each=function(c,f,d){if(null!=c)if(a&&c.forEach===a)c.forEach(f,d);else if(c.length===+c.length)for(var e=0,g=c.length;e<g&&!(e in c&&f.call(d,c[e],e,c)===b);e++);else for(e in c)if(c.hasOwnProperty.call(c,e)&&f.call(d,c[e],e,c)===b)break}})();
